<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Wind Explorer</title>
    
    <style>
        body { margin: 0; background: #f8fafc; font-family: -apple-system, sans-serif; }
        #system-log { font-family: monospace; padding: 10px; background: #fff1f2; color: #9f1239; border-bottom: 1px solid #e11d48; display: none; font-size: 12px; }
        .error-boundary { padding: 20px; border: 2px solid #ef4444; background: #fef2f2; border-radius: 8px; margin: 20px; color: #991b1b; }
    </style>
    
    <script>
        window.onerror = function(msg, url, line) {
            var log = document.getElementById('system-log');
            log.style.display = 'block';
            log.innerHTML += '<div><strong>Error:</strong> ' + msg + ' (Line ' + line + ')</div>';
            return false;
        };
    </script>

    <!-- Environment Shim -->
    <script>window.process = { env: { NODE_ENV: 'production' } };</script>

    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Recharts Dependencies -->
    <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
</head>
<body>
    <div id="system-log"></div>
    <div id="root">
        <div style="height: 100vh; display: flex; justify-content: center; align-items: center; color: #64748b;">
            Loading application resources...
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="error-boundary">
                            <h2 className="text-xl font-bold mb-2">Application Crash</h2>
                            <p className="font-mono text-sm bg-white p-4 border rounded">
                                {this.state.error && this.state.error.toString()}
                            </p>
                            <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-red-600 text-white rounded">Reload</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } = window.Recharts;

        // --- PHYSICS CONSTANTS ---
        const LSUN = 3.828e33; 
        const SIGMA_SB = 5.670374419e-5; 
        const RSUN = 6.957e10; 

        const calcRadius = (L_sol, T_eff) => {
            const L_cgs = L_sol * LSUN;
            const R_cgs = Math.sqrt(L_cgs / (4 * Math.PI * SIGMA_SB * Math.pow(T_eff, 4)));
            return R_cgs / RSUN;
        };

        const log10 = (x) => Math.log10(x > 1e-10 ? x : 1e-10);

        // --- RECIPES ---
        const recipes = {
            Reimers75: (p) => log10(4e-13 * (p.L * p.R / p.M)),
            deJager88: (p) => 1.769 * log10(p.L) - 1.676 * log10(p.T) - 8.158,
            vanLoon05: (p) => 1.05 * log10(p.L / 10000) - 6.3 * log10(p.T / 3500) - 5.56,
            Vink01: (p) => {
                const v_inf_esc_hot = 2.6 * Math.pow(p.Z, 0.13); 
                const v_inf_esc_cool = 1.3 * Math.pow(p.Z, 0.13);
                if (p.T > 25000) {
                    return -6.697 + 2.194 * log10(p.L/1e5) - 1.313 * log10(p.M/30) - 1.226 * log10(v_inf_esc_hot/2.0) + 0.933 * log10(p.T/40000) - 10.92 * Math.pow(log10(p.T/40000), 2) + 0.85 * log10(p.Z);
                } else {
                    return -6.688 + 2.210 * log10(p.L/1e5) - 1.339 * log10(p.M/30) - 1.601 * log10(v_inf_esc_cool/2.0) + 1.07 * log10(p.T/20000) + 0.85 * log10(p.Z);
                }
            },
            Bjorklund23: (p) => -5.52 + 2.39 * log10(p.L/1e6) - 1.48 * log10(p.M/45) + 2.12 * log10(p.T/45000) + (0.75 - 1.87 * log10(p.T/45000)) * log10(p.Z),
            Krticka24: (p) => {
                const lZ = log10(p.Z);
                const tk = p.T / 1000.0;
                const t1 = Math.exp(-Math.pow((tk - 14.16) / 3.58, 2));
                const t2 = 3.84 * Math.exp(-Math.pow((tk - 37.9) / 56.5, 2));
                return -13.82 + 0.358 * lZ + (1.52 - 0.11 * lZ) * (log10(p.L) - 6.0) + 13.82 * log10((1.0 + 0.73 * lZ) * t1 + t2);
            },
            Vink17: (p) => -13.3 + 1.36 * log10(p.L) + 0.61 * log10(p.Z),
            NugisLamers00: (p) => {
                const Y = Math.max(0.01, 1.0 - p.X - (p.Z * 0.014));
                return -13.60 + 1.63 * log10(p.L) + 2.22 * log10(Y) + 0.85 * log10(p.Z);
            },
            Langer89: (p) => 2.5 * log10(p.M) + 0.85 * log10(p.Z) - 7.1
        };

        const RECIPE_META = {
            Reimers75: { color: "#ef4444", name: "Reimers (1975)", category: "Cool" },
            deJager88: { color: "#f97316", name: "de Jager (1988)", category: "Cool" },
            vanLoon05: { color: "#ea580c", name: "van Loon (2005)", category: "Cool" },
            Vink01: { color: "#3b82f6", name: "Vink et al. (2001)", category: "Thin" },
            Bjorklund23: { color: "#06b6d4", name: "BjÃ¶rklund et al. (2023)", category: "Thin" },
            Krticka24: { color: "#8b5cf6", name: "Krticka et al. (2024)", category: "Thin" },
            Vink17: { color: "#6366f1", name: "Vink (2017)", category: "Thin" },
            NugisLamers00: { color: "#10b981", name: "Nugis & Lamers (2000)", category: "WR" },
            Langer89: { color: "#84cc16", name: "Langer (1989)", category: "WR" },
        };

        const App = () => {
            const [axisChoice, setAxisChoice] = useState('temp'); // Renamed from Teff to axisChoice
            const [params, setParams] = useState({ logL: 5.0, mass: 40.0, logT: 4.6, z: 1.0, hydrogen: 0.7 });
            const [models, setModels] = useState({ Vink01: true, Bjorklund23: true, Krticka24: false, Reimers75: false, deJager88: false, NugisLamers00: false });

            const plotData = useMemo(() => {
                const data = [];
                let min, max;
                if (axisChoice === 'temp') { min = 3.5; max = 5.3; }
                else if (axisChoice === 'lum') { min = 3.0; max = 6.5; }
                else { min = -2.0; max = 0.5; }

                for (let i = 0; i <= 100; i++) {
                    const xLog = min + i * ((max - min) / 100);
                    const xLin = Math.pow(10, xLog);
                    const p = {
                        L: axisChoice === 'lum' ? xLin : Math.pow(10, params.logL),
                        M: params.mass,
                        T: axisChoice === 'temp' ? xLin : Math.pow(10, params.logT),
                        Z: axisChoice === 'metal' ? xLin : params.z,
                        X: params.hydrogen
                    };
                    p.R = calcRadius(p.L, p.T);
                    const point = { x: xLog };
                    Object.keys(recipes).forEach(k => { if (models[k]) point[k] = recipes[k](p); });
                    data.push(point);
                }
                return data;
            }, [axisChoice, params, models]);

            // Descriptive labels to avoid unquoted letter issues
            const xLabel = axisChoice === 'temp' ? 'log Teff [K]' : axisChoice === 'lum' ? 'log L/Lsun' : 'log Z/Zsun';
            const titleLabel = axisChoice === 'temp' ? 'Temperature' : axisChoice === 'lum' ? 'Luminosity' : 'Metallicity';

            return (
                <div className="min-h-screen p-4 md:p-8 text-slate-800">
                    <header className="mb-8 max-w-6xl mx-auto flex justify-between items-center">
                        <h1 className="text-3xl font-bold text-blue-700">Stellar Wind Models</h1>
                        <a href="https://github.com/AmedeoRom" className="text-sm text-slate-500 hover:text-blue-600">GitHub Profile</a>
                    </header>

                    <div className="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-6">
                        <div className="lg:col-span-3 space-y-6">
                            {/* Axis */}
                            <div className="bg-white p-5 rounded-xl border shadow-sm">
                                <h3 className="text-xs uppercase font-bold text-slate-400 mb-4">Plot Axis</h3>
                                {['temp', 'lum', 'metal'].map(t => (
                                    <label key={t} className="flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer rounded">
                                        <input type="radio" checked={axisChoice === t} onChange={() => setAxisChoice(t)} className="accent-blue-600" />
                                        <span className="capitalize">{t === 'temp' ? 'Temperature' : t === 'lum' ? 'Luminosity' : 'Metallicity'}</span>
                                    </label>
                                ))}
                            </div>

                            {/* Sliders */}
                            <div className="bg-white p-5 rounded-xl border shadow-sm">
                                <h3 className="text-xs uppercase font-bold text-slate-400 mb-4">Parameters</h3>
                                <div className="space-y-4">
                                    {axisChoice !== 'lum' && (
                                        <div>
                                            <div className="flex justify-between text-xs mb-1"><span>log L</span><span className="font-bold text-blue-600">{params.logL}</span></div>
                                            <input type="range" min="3" max="6.5" step="0.1" value={params.logL} onChange={(e) => setParams({...params, logL: parseFloat(e.target.value)})} className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                        </div>
                                    )}
                                    <div>
                                        <div className="flex justify-between text-xs mb-1"><span>Mass (Msun)</span><span className="font-bold text-blue-600">{params.mass}</span></div>
                                        <input type="range" min="5" max="100" step="1" value={params.mass} onChange={(e) => setParams({...params, mass: parseFloat(e.target.value)})} className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                    {axisChoice !== 'temp' && (
                                        <div>
                                            <div className="flex justify-between text-xs mb-1"><span>log Teff</span><span className="font-bold text-blue-600">{params.logT}</span></div>
                                            <input type="range" min="3.5" max="5.3" step="0.05" value={params.logT} onChange={(e) => setParams({...params, logT: parseFloat(e.target.value)})} className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                        </div>
                                    )}
                                    {axisChoice !== 'metal' && (
                                        <div>
                                            <div className="flex justify-between text-xs mb-1"><span>Z/Zsun</span><span className="font-bold text-blue-600">{params.z}</span></div>
                                            <input type="range" min="0.01" max="2.0" step="0.01" value={params.z} onChange={(e) => setParams({...params, z: parseFloat(e.target.value)})} className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer" />
                                        </div>
                                    )}
                                </div>
                            </div>

                            {/* Models */}
                            <div className="bg-white p-5 rounded-xl border shadow-sm">
                                <h3 className="text-xs uppercase font-bold text-slate-400 mb-4">Models</h3>
                                <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                    {Object.keys(recipes).map(k => (
                                        <label key={k} className="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" checked={models[k]} onChange={() => setModels({...models, [k]: !models[k]})} className="accent-blue-600" />
                                            <span className="text-sm truncate" title={RECIPE_META[k].name}>{RECIPE_META[k].name}</span>
                                        </label>
                                    ))}
                                </div>
                            </div>
                        </div>

                        {/* Chart */}
                        <div className="lg:col-span-9 bg-white p-6 rounded-xl border shadow-sm h-[600px] flex flex-col">
                            <h2 className="font-bold mb-4">log M-dot vs {titleLabel}</h2>
                            <div className="flex-1">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={plotData} margin={{ top: 10, right: 30, left: 20, bottom: 40 }}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#f1f5f9" />
                                        <XAxis 
                                            dataKey="x" 
                                            type="number" 
                                            domain={['auto', 'auto']} 
                                            reversed={axisChoice === 'temp'} 
                                            tickFormatter={v => v.toFixed(2)}
                                            label={{ value: xLabel, position: 'bottom', offset: 20 }}
                                        />
                                        <YAxis label={{ value: 'log M-dot [Msun/yr]', angle: -90, position: 'insideLeft' }} />
                                        <Tooltip labelFormatter={v => titleLabel + ': ' + v.toFixed(3)} />
                                        <Legend verticalAlign="top" height={36}/>
                                        {Object.keys(recipes).map(k => models[k] && (
                                            <Line key={k} type="monotone" dataKey={k} stroke={RECIPE_META[k].color} name={RECIPE_META[k].name} strokeWidth={2} dot={false} />
                                        ))}
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
