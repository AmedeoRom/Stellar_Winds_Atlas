<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stellar Wind Atlas</title>
    
    <style>
        /* Global Font Change to Candara */
        * {
            font-family: "Candara", "Calibri", "Optima", "Segoe UI", sans-serif;
        }
        body { 
            margin: 0; 
            background: #f8fafc; 
        }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        input[type=range] { accent-color: #2563eb; }
        .model-card { transition: all 0.2s; border: 1px solid #e2e8f0; }
        .model-card:hover { border-color: #3b82f6; background-color: #eff6ff; }
        .collapsible-header { cursor: pointer; user-select: none; transition: background 0.2s; }
        .collapsible-header:hover { background-color: #f1f5f9; }
        .warning-tooltip { position: relative; display: inline-block; cursor: help; margin-left: 4px; }
    </style>

    <script>window.process = { env: { NODE_ENV: 'production' } };</script>
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script crossorigin src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, ReferenceArea, ReferenceLine, Label } = window.Recharts;

        // --- CONSTANTS ---
        const LSUN_CGS = 3.826e33; 
        const RSUN_CGS = 6.9599e10; 
        const MSUN_CGS = 1.989e33;
        const G_CGS = 6.67430e-8;
        const Z_SUN = 0.0142;
        const log10 = (x) => Math.log10(x > 1e-45 ? x : 1e-45);

        // --- PHYSICS UTILS ---
        const calcRadius = (L_sol, T_eff) => {
            return Math.sqrt(L_sol) / Math.pow(T_eff / 5778, 2);
        };

        const calcLogG = (M_sol, R_sol) => {
            return Math.log10(G_CGS * (M_sol * MSUN_CGS) / Math.pow(R_sol * RSUN_CGS, 2));
        };

        const CATEGORIES = {
            LOW: { label: "Low-Mass Winds", color: "slate", warning: "Restricted to luminosity < cutoff." },
            THIN: { label: "Optically Thin (Hot Stars)", color: "blue", warning: "Tunable Teff range applied." },
            THICK: { label: "Optically Thick (Wolf-Rayet)", color: "emerald" },
            COOL: { label: "Cool Supergiant Winds", color: "orange", warning: "Tunable Teff cutoff applied." },
            OTHER: { label: "Other Options", color: "indigo" }
        };

        const MODEL_META = {
            R75: { name: "Reimers 1975", cat: "LOW", color: "#000000", dash: "0", year: 1975 },
            B95: { name: "Bloecker 1995", cat: "LOW", color: "#64748b", dash: "5 5", year: 1995 },
            NdJ90: { name: "Nieuwenhuijzen+ 1990", cat: "THIN", color: "#1e3a8a", dash: "0", year: 1990 },
            Vb98_OB: { name: "Vanbeveren+ 1998 (OB)", cat: "THIN", color: "#1e3a8a", dash: "5 5", year: 1998 },
            V01: { name: "Vink+ 2001", cat: "THIN", color: "#2563eb", dash: "0", year: 2001 },
            V17: { name: "Vink 2017", cat: "THIN", color: "#7c3aed", dash: "0", year: 2017 },
            VS21: { name: "Vink & Sander 2021", cat: "THIN", color: "#2563eb", dash: "5 5", year: 2021 },
            Bj23: { name: "Bjorklund+ 2023", cat: "THIN", color: "#7c3aed", dash: "5 5", year: 2023 },
            GM23: { name: "Gormaz-Matamala+ 2023", cat: "THIN", color: "#0ea5e9", dash: "0", year: 2023, warning: "Restricted to log(g) > 3.2." },
            K24: { name: "Krticka+ 2024", cat: "THIN", color: "#4f46e5", dash: "0", year: 2024, warning: "Restricted to Z >= 0.2 Zsun." },
            K25: { name: "Krticka+ 2025", cat: "THIN", color: "#4f46e5", dash: "5 5", year: 2025, warning: "Restricted to 10 - 45 kK and Z < Zsun." },
            Sa25: { name: "Sabhahit+ 2025", cat: "THIN", color: "#a855f7", dash: "0", year: 2025.2 },
            P25: { name: "Pauli+ 2025", cat: "THIN", color: "#312e81", dash: "0", year: 2025.3 },
            L89: { name: "Langer 1989", cat: "THICK", color: "#064e3b", dash: "0", year: 1989 },
            Ha95: { name: "Hamann+ 1995", cat: "THICK", color: "#92400e", dash: "0", year: 1995 },
            Vb98_WR: { name: "Vanbeveren+ 1998 (WR)", cat: "THICK", color: "#064e3b", dash: "5 5", year: 1998 },
            NL00: { name: "Nugis & Lamers 2000", cat: "THICK", color: "#059669", dash: "0", year: 2000 },
            Y06: { name: "Yoon+ 2006", cat: "THICK", color: "#059669", dash: "5 5", year: 2006 },
            GH08: { name: "Grafener & Hamann 2008", cat: "THICK", color: "#0d9488", dash: "0", year: 2008, warning: "Restricted to logL > 5.7" },
            V11: { name: "Vink+ 2011", cat: "THICK", color: "#b45309", dash: "0", year: 2011 },
            TSK16: { name: "Tramper+ 2016", cat: "THICK", color: "#0d9488", dash: "5 5", year: 2016 },
            Y17: { name: "Yoon 2017", cat: "THICK", color: "#15803d", dash: "0", year: 2017 },
            Sh19: { name: "Shenar+ 2019", cat: "THICK", color: "#92400e", dash: "5 5", year: 2019 },
            S19: { name: "Sander+ 2019", cat: "THICK", color: "#166534", dash: "0", year: 2019.2 },
            B20: { name: "Bestenlehner 2020", cat: "THICK", color: "#166534", dash: "5 5", year: 2020.1 },
            SV20: { name: "Sander & Vink 2020", cat: "THICK", color: "#b45309", dash: "5 5", year: 2020.2 },
            dJ88: { name: "de Jager+ 1988", cat: "COOL", color: "#ea580c", dash: "0", year: 1988 },
            Vb98_cool: { name: "Vanbeveren+ 1998 (Cool)", cat: "COOL", color: "#eab308", dash: "0", year: 1998 },
            vL05: { name: "van Loon+ 2005", cat: "COOL", color: "#ea580c", dash: "5 5", year: 2005 },
            Be23: { name: "Beasor+ 2023", cat: "COOL", color: "#ca8a04", dash: "0", reqMini: true, year: 2023 },
            Ya23: { name: "Yang+ 2023", cat: "COOL", color: "#ca8a04", dash: "5 5", year: 2023.2 },
            A24: { name: "Antoniadis+ 2024", cat: "COOL", color: "#ef4444", dash: "0", year: 2024, warning: "Capped at 4 kK." },
            D24: { name: "Decin+ 2024", cat: "COOL", color: "#ef4444", dash: "5 5", reqMini: true, year: 2024.2 }
        };

        const recipes = {
            R75: (p, s) => (log10(p.L) > s.lumCutoff) ? null : log10((p.h1_center > 0.001 ? 0.85 : (p.L/p.Ledd > 1 ? 3.0 : 1.0)) * 4e-13 * (p.L * p.R / p.M)),
            B95: (p, s) => (log10(p.L) > s.lumCutoff) ? null : log10(0.1 * 4.83e-9 * Math.pow(p.M, -2.1) * Math.pow(p.L, 2.7) * 4e-13 * p.L * p.R / p.M),
            V01: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) return null;
                const vi_r = (p.T > 25000 ? 2.6 : 1.3) * Math.pow(p.Z / s.Zsun, 0.13);
                if (p.T > 25000) return -6.697 + 2.194*log10(p.L/1e5) - 1.313*log10(p.M/30) - 1.226*log10(vi_r/2) + 0.933*log10(p.T/4e4) - 10.92*Math.pow(log10(p.T/4e4), 2) + 0.85*log10(p.Z/s.Zsun);
                return -6.688 + 2.210*log10(p.L/1e5) - 1.339*log10(p.M/30) - 1.601*log10(vi_r/2) + 1.07*log10(p.T/2e4) + 0.85*log10(p.Z/s.Zsun);
            },
            VS21: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) return null;
                let vi, logMdot;
                if (p.T > 25000) {
                    vi = 2.6 * Math.pow(p.Z/s.Zsun, 0.13);
                    logMdot = -6.697 + 2.194*log10(p.L/1e5) - 1.313*log10(p.M/30) - 1.226*log10(vi/2) + 0.933*log10(p.T/4e4) - 10.92*Math.pow(log10(p.T/4e4), 2) + 0.85*log10(p.Z/s.Zsun);
                } else if (p.T > 20000) {
                    vi = 1.3 * Math.pow(p.Z/s.Zsun, 0.13);
                    logMdot = -6.688 + 2.210*log10(p.L/1e5) - 1.339*log10(p.M/30) - 1.601*log10(vi/2) + 1.07*log10(p.T/2e4) + 0.85*log10(p.Z/s.Zsun);
                } else {
                    vi = 0.7 * Math.pow(p.Z/s.Zsun, 0.13);
                    logMdot = -5.99 + 2.21*log10(p.L/1e5) - 1.339*log10(p.M/30) - 1.601*log10(vi/2) + 1.07*log10(p.T/2e4) + 0.85*log10(p.Z/s.Zsun);
                }
                return logMdot;
            },
            V17: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) ? null : -13.3 + 1.36 * log10(p.L) + 0.61 * log10(p.Z/s.Zsun),
            Bj23: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) ? null : -5.52 + 2.39 * log10(p.L/1e6) - 1.48 * log10(p.M/45) + 2.12 * log10(p.T/4.5e4) + (0.75 - 1.87 * log10(p.T/4.5e4)) * log10(p.Z/s.Zsun),
            K24: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin || (p.Z / s.Zsun < 0.2)) return null;
                const logZ_div_Zsun = log10(p.Z/s.Zsun); const Tsurf = p.T;
                return -13.82 + 0.358*logZ_div_Zsun + (1.52 - 0.11*logZ_div_Zsun)*(log10(p.L) - 6.0) + 13.82 * log10((1.0 + 0.73*logZ_div_Zsun)*Math.exp(-Math.pow((Tsurf/1000.0 - 14.16)/3.58, 2)) + 3.84*Math.exp(-Math.pow((Tsurf/1000.0 - 37.9)/56.5, 2)));
            },
            K25: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin || p.T < 10000 || p.T > 45000) return null;
                const l_coeffs = [[-31.333,-46.3518,-19.0704,0.372222],[119.62,70.4817,170.353,0.119759],[-201.713,-284.575,-115.793,0],[208.466,117.131,292.063,0],[-140.704,-195.337,-77.1403,0],[58.7226,31.2397,80.3569,0],[-11.7687,-15.3933,-5.729,0]];
                const lZ = Math.max(-2, Math.min(0, log10(p.Z/s.Zsun))); const t = (p.T/1000 - 10) / 35;
                const polys = [t, -0.5+1.5*t**2, 2.5*t**3-1.5*t, 0.375+4.375*t**4-3.75*t**2, 7.875*t**5-8.75*t**3+1.875*t, -0.3125+14.4375*t**6-19.6875*t**4+6.5625*t**2, 26.8125*t**7-43.3125*t**5+19.6875*t**3-2.1875*t];
                let sum = 0; for(let i=0; i<7; i++) { sum += (l_coeffs[i][0] + l_coeffs[i][1]*lZ + l_coeffs[i][2]*lZ**2 + l_coeffs[i][3]*lZ**3) * polys[i]; }
                return -7.0 + 1.619*log10(p.L/1e6) + sum;
            },
            GM23: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) return null;
                const logg = calcLogG(p.M, p.R); if (logg <= 3.2) return null;
                const lt = log10(p.T/1000); const lz = log10(p.Z/s.Zsun);
                let m = -40.314 + 15.438*lt + 45.838/logg - 8.284*lt/logg + 1.0564*p.R - lt*p.R/2.36 - 1.1967*p.R/logg + 11.6*lz - 4.223*lt*lz - 16.377*lz/logg + (p.R*lz)/81.735;
                return m + 0.0475 - 0.559*0.085;
            },
            Sa25: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) ? null : -5.527 + 3.974 * Math.pow(log10(p.T/38000), 2) - 2.062 * log10(p.T/38000),
            NdJ90: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : log10(9.6e-15 * Math.pow(Math.sqrt(p.L)/Math.pow(p.T/5772, 2), 0.81) * Math.pow(p.L, 1.24) * Math.pow(p.M, 0.16) * Math.pow(p.Z/s.Zsun, 0.5)),
            Vb98_OB: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.thinTMax || log10(p.T) < s.thinTMin) ? null : 1.67*log10(p.L) - 1.55*log10(p.T) + 0.85*log10(p.Z/s.Zsun) - 8.29,
            P25: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : -3.92 + 4.27*(-4.813 + log10(1+p.X) + log10(p.L) - log10(p.M)) + 0.86*log10(p.Z/s.Zsun),
            L89: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : 2.5 * log10(p.M) + 0.85 * log10(p.Z/s.Zsun) - 7.1,
            NL00: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : -13.6 + 1.63 * log10(p.L) + 2.22 * log10(1-p.X) + 0.85 * log10(p.Z/s.Zsun),
            Y06: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : log10(p.L) > 4.5 ? -12.95 + 1.5*log10(p.L) - 2.85*p.X + 0.85*log10(p.Z/s.Zsun) : -36.8 + 6.8*log10(p.L),
            Y17: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : log10(Math.pow(p.L, 1.18) * Math.pow(p.Z/s.Zsun, 0.6) * Math.pow(10, -11.32)),
            V11: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : log10(s.mdot) + 4.77 * log10(p.L/s.L) - 3.99 * log10(p.M/s.M),
            SV20: (p, s, opts = {}) => {
                if (log10(p.L) <= s.lumCutoff) return null;
                const log_ge = -4.813 + log10(1+p.X) + log10(p.L) - log10(p.M);
                const gamma_edd = Math.min(0.999, Math.pow(10, log_ge));
                const lZ = log10(p.Z/s.Zsun);
                const logMdot_pureWR = 2.932 * (log10(-log10(1.0 - gamma_edd))) + (0.23 * lZ - 2.61);
                const breakdown_val = Math.max(0, (-0.324 * lZ + 0.244) / gamma_edd);
                const logMdot_breakdown = log10(2.0) * Math.pow(breakdown_val, (-0.44 * lZ + 9.15));
                let xlmdot = logMdot_pureWR - logMdot_breakdown;
                if (opts.sv20TCorr && p.T >= 1e5) xlmdot -= 6.0 * log10(p.T/141000);
                return xlmdot;
            },
            TSK16: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : 0.85 * log10(p.L) + 0.44 * log10(1-p.X) + 0.25 * log10(p.Z/s.Zsun) - 9.2,
            GH08: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.L) < 5.7) ? null : 10.046 + 1.727 * log10((Math.pow(10, -4.813 + log10(1+p.X) + log10(p.L) - log10(p.M))) - 0.326) - 3.5 * log10(p.T) + 0.42 * log10(p.L) - 0.45 * p.X,
            Ha95: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : 1.5*log10(p.L) + 0.85*log10(p.Z/s.Zsun) - 2.85*p.X - 11.95,
            Sh19: (p, s) => {
                if (log10(p.L) <= s.lumCutoff) return null;
                let C = (p.X >= 0.4) ? [ -8.13, 1.01, -0.06, 1.42, 0.95 ] : [ -6.50, 0.79, -0.37, 1.42, 0.68 ];
                return C[0] + C[1]*log10(p.L) + C[2]*log10(p.T) + C[3]*log10(1-p.X) + C[4]*log10(p.Z/s.Zsun);
            },
            S19: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : -8.31 + 0.68*log10(p.L),
            B20: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : -5.19 + 2.69*log10(Math.pow(10, -4.813) * (1+p.X) * p.L / p.M) - 3.19*log10(1-(Math.pow(10, -4.813) * (1+p.X) * p.L / p.M)) + (log10(p.Z/s.Zsun)+0.3)*(0.4 + 15.75/p.M),
            Vb98_WR: (p, s) => (log10(p.L) <= s.lumCutoff) ? null : log10(p.L) + 0.85*log10(p.Z/s.Zsun) - 10,
            dJ88: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : 1.769 * log10(p.L) - 1.676 * log10(p.T) - 8.158,
            vL05: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : 1.05 * log10(p.L/1e4) - 6.3 * log10(p.T/3500) - 5.56,
            Be23: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : -0.15 * p.Mi + 3.6 * log10(p.L) - 21.5,
            Ya23: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : 0.45 * log10(p.L)**3 - 5.26 * Math.pow(log10(p.L), 2) + 20.93 * log10(p.L) - 34.56,
            A24: (p, s) => {
                if (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) return null;
                const effectiveT = p.T > 4000 ? 4000 : p.T; const logL = log10(p.L);
                if (logL < 4.4) return 0.26 * logL - 14.19 * log10(Math.min(p.T, 4000) / 4000) - 9.17;
                return 2.49536 * logL - (p.T < 4000 ? 33.7 * log10(p.T/4000) : 0) - 19.1022;
            },
            D24: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : 1.71 - 1.63 * (p.Mi/10) + 3.47 * log10(p.L/1e5) - 5,
            Vb98_cool: (p, s) => (log10(p.L) <= s.lumCutoff || log10(p.T) > s.coolCutoff) ? null : 0.8*log10(p.L) - 8.7
        };

        const App = () => {
            const [axis, setAxis] = useState('temp');
            const [params, setParams] = useState({ logL: 5.8, mass: 40.0, logT: 4.6, z: 0.0142, X: 0.7, Mi: 40, Zsun: 0.0142, thinTMin: 3.6, thinTMax: 4.8, coolCutoff: 4.0, lumCutoff: 4.0 });
            const [activeModels, setActiveModels] = useState({ K24: true, dJ88: true, Sh19: true });
            const [options, setOptions] = useState({ sv20TCorr: false, moreDetails: false });
            const [vinkSettings, setVinkSettings] = useState({ mdot: 1e-5, L: 1e5, M: 40 });
            const [showVinkModal, setShowVinkModal] = useState(false);
            const [expandedCats, setExpandedCats] = useState({ LOW: false, THIN: false, THICK: false, COOL: false, OTHER: false, PLOT: false });
            const [plotOpt, setPlotOpt] = useState({ xmin: 3.5, xmax: 4.6, ymin: -11, ymax: -3, height: 720, autoY: true, linearX: false });

            const sortedModels = useMemo(() => Object.entries(MODEL_META).sort((a, b) => a[1].year - b[1].year), []);

            const plotData = useMemo(() => {
                const data = []; const stepCount = 100;
                const curMin = plotOpt.xmin; const curMax = plotOpt.xmax;
                for (let i = 0; i <= stepCount; i++) {
                    const xLog = curMin + i * (curMax - curMin) / stepCount;
                    const xLin = Math.pow(10, xLog);
                    const p = { L: axis === 'lum' ? xLin : Math.pow(10, params.logL), M: params.mass, T: axis === 'temp' ? xLin : Math.pow(10, params.logT), Z: axis === 'metal' ? xLin : params.z, X: params.X, Mi: params.Mi };
                    p.R = calcRadius(p.L, p.T);
                    const point = { x: xLog, linearX: xLin };
                    Object.keys(activeModels).forEach(k => {
                        if (activeModels[k]) {
                            const val = (k === 'V11') ? recipes[k](p, vinkSettings) : recipes[k](p, params, options);
                            if (val !== null && !isNaN(val)) point[k] = val;
                        }
                    });
                    data.push(point);
                }
                return data;
            }, [axis, params, activeModels, vinkSettings, plotOpt.xmin, plotOpt.xmax, options]);

            useEffect(() => {
                if (plotOpt.autoY && plotData.length > 0) {
                    let min = Infinity, max = -Infinity;
                    plotData.forEach(p => { Object.keys(p).forEach(k => { if (k !== 'x' && k !== 'linearX') { if (p[k] < min) min = p[k]; if (p[k] > max) max = p[k]; } }); });
                    if (min !== Infinity) setPlotOpt(p => ({...p, ymin: Math.floor(min - 0.5), ymax: Math.ceil(max + 0.5)}));
                }
            }, [plotData, plotOpt.autoY]);

            useEffect(() => {
                if (axis === 'temp') setPlotOpt(p => ({...p, xmin: 3.5, xmax: 4.6}));
                else if (axis === 'lum') setPlotOpt(p => ({...p, xmin: 4.0, xmax: 6.5}));
                else setPlotOpt(p => ({...p, xmin: -3.0, xmax: 0.5}));
            }, [axis]);

            const getShadeBounds = (rMin_log, rMax_log) => {
                const dMin = Math.min(plotOpt.xmin, plotOpt.xmax);
                const dMax = Math.max(plotOpt.xmin, plotOpt.xmax);
                const effMin = rMin_log < -20 ? dMin : rMin_log;
                const effMax = rMax_log > 20 ? dMax : rMax_log;
                const vStart = Math.max(effMin, dMin);
                const vEnd = Math.min(effMax, dMax);
                if (vStart >= vEnd) return null;
                return {
                    x1: plotOpt.linearX ? Math.pow(10, vStart) : vStart,
                    x2: plotOpt.linearX ? Math.pow(10, vEnd) : vEnd,
                    mid: plotOpt.linearX ? Math.pow(10, (vStart + vEnd) / 2) : (vStart + vEnd) / 2
                };
            };

            const xLabel = axis === 'temp' ? 'log (Teff / K)' : axis === 'lum' ? 'log (L / Lsun)' : 'log (Z / Zsun)';
            const needsInitialMass = useMemo(() => Object.keys(activeModels).some(k => activeModels[k] && MODEL_META[k].reqMini), [activeModels]);

            return (
                <div className="flex flex-col h-screen overflow-hidden bg-slate-50 text-slate-800">
                    <header className="px-6 py-3 bg-white border-b flex justify-between items-center shadow-sm z-10">
                        <h1 className="text-xl font-bold italic text-slate-700">Stellar Wind Atlas <span className="text-xs font-normal text-slate-400 not-italic ml-2">v1.0.0</span></h1>
                        <a href="https://github.com/AmedeoRom" className="text-xs text-slate-400 hover:text-blue-600 transition" target="_blank">GitHub Profile</a>
                    </header>

                    <main className="flex-1 flex overflow-hidden">
                        <aside className="w-80 border-r bg-white flex flex-col overflow-y-auto p-4 custom-scrollbar space-y-4">
                            {Object.entries(CATEGORIES).map(([id, cat]) => (
                                <div key={id} className="border rounded-xl overflow-hidden shadow-sm">
                                    <div onClick={() => setExpandedCats(p => ({ ...p, [id]: !p[id] }))} className={`collapsible-header flex justify-between items-center p-3 bg-${cat.color}-50 text-${cat.color}-800 border-b`}>
                                        <span className="text-xs font-black uppercase tracking-widest">{cat.label}</span>
                                        <div className="flex items-center gap-2">
                                            {cat.warning && <span className="text-[10px]" title={cat.warning}>⚠️</span>}
                                            <svg className={`w-4 h-4 transition-transform ${expandedCats[id] ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M19 9l-7 7-7-7" /></svg>
                                        </div>
                                    </div>
                                    {expandedCats[id] && (
                                        <div className="p-2 space-y-1 bg-white max-h-64 overflow-y-auto custom-scrollbar">
                                            {id === 'OTHER' ? (
                                                <div className="p-3 space-y-4 text-xs">
                                                    <label className="flex items-center gap-3 p-2 hover:bg-slate-50 cursor-pointer rounded-lg border border-transparent hover:border-slate-200 transition" title="Adds information on supergiant and WR temperature ranges, HD limit and Pop I to III metallicity regimes">
                                                        <input type="checkbox" checked={options.moreDetails} onChange={e => setOptions({...options, moreDetails: e.target.checked})} className="w-4 h-4 text-blue-600 rounded" />
                                                        <span className="font-bold">More Details</span>
                                                    </label>
                                                    <div className="pt-2 border-t border-slate-100">
                                                        <label className="text-[10px] font-black text-slate-400 uppercase cursor-help block" title="Anders+ 1989 (0.019), Grevesse+ 1998 (0.017), or Asplund+ 2009 (0.0142)">Zsun Calibration</label>
                                                        <input type="number" step="0.0001" value={params.Zsun} onChange={e => setParams({...params, Zsun: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block">Thin logTeff Cutoffs (Min/Max)</label>
                                                        <div className="flex gap-2">
                                                            <input type="number" step="0.1" value={params.thinTMin} onChange={e => setParams({...params, thinTMin: parseFloat(e.target.value)})} className="w-1/2 mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                                            <input type="number" step="0.1" value={params.thinTMax} onChange={e => setParams({...params, thinTMax: parseFloat(e.target.value)})} className="w-1/2 mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                                        </div>
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block">Cool logTeff Cutoff</label>
                                                        <input type="number" step="0.1" value={params.coolCutoff} onChange={e => setParams({...params, coolCutoff: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase block text-indigo-600 font-bold italic">High/Low-mass logL cutoff</label>
                                                        <input type="number" step="0.1" value={params.lumCutoff} onChange={e => setParams({...params, lumCutoff: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-indigo-50 border border-indigo-200 rounded font-mono text-indigo-800" />
                                                    </div>
                                                </div>
                                            ) : sortedModels.filter(([_, m]) => m.cat === id).map(([key, meta]) => (
                                                <div key={key} className="model-card p-2 rounded-lg cursor-default select-none">
                                                    <label className="flex items-center cursor-pointer">
                                                        <input type="checkbox" checked={!!activeModels[key]} onChange={() => {
                                                            setActiveModels(p => ({ ...p, [key]: !p[key] }));
                                                            if (key === 'V11' && !activeModels[key]) setShowVinkModal(true);
                                                        }} className="mr-3 h-4 w-4 rounded text-blue-600 focus:ring-blue-500" />
                                                        <div className="flex-1 overflow-hidden">
                                                            <div className="flex items-center gap-1">
                                                                <div className="text-[11px] font-bold text-slate-700 truncate">{meta.name}</div>
                                                                {meta.warning && <div className="warning-tooltip" title={meta.warning}><span className="text-[10px]">⚠️</span></div>}
                                                            </div>
                                                            <div className="flex items-center gap-2 mt-1">
                                                                <div className="h-0.5 w-8" style={{ background: meta.color, borderTop: meta.dash === "0" ? 'none' : `2.5px dashed ${meta.color}` }}></div>
                                                                <span className="text-[9px] text-slate-400 font-mono italic">{Math.floor(meta.year)}</span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                    {key === 'SV20' && activeModels.SV20 && (
                                                        <div className="mt-2 ml-7 pl-2 border-l border-slate-200">
                                                            <label className="flex items-center gap-2 cursor-pointer group">
                                                                <input type="checkbox" checked={options.sv20TCorr} onChange={e => setOptions({...options, sv20TCorr: e.target.checked})} className="w-3 h-3 rounded" />
                                                                <span className="text-[10px] font-bold text-slate-500 group-hover:text-blue-600" title="From Sander+ (2023)">T-correction</span>
                                                            </label>
                                                        </div>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            ))}
                        </aside>

                        <section className="flex-1 flex flex-col p-6 space-y-4 overflow-y-auto custom-scrollbar">
                            <div className="bg-white rounded-2xl shadow-sm border p-4 flex flex-col shrink-0" style={{ height: plotOpt.height + 'px' }}>
                                <div className="flex-1">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <LineChart data={plotData} margin={{ top: 20, right: 20, left: 10, bottom: 100 }}>
                                            <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                                            <XAxis 
                                                dataKey={plotOpt.linearX ? "linearX" : "x"} 
                                                type="number" 
                                                domain={[plotOpt.linearX ? Math.pow(10, plotOpt.xmin) : plotOpt.xmin, plotOpt.linearX ? Math.pow(10, plotOpt.xmax) : plotOpt.xmax]} 
                                                reversed={axis === 'temp'} 
                                                tickFormatter={v => plotOpt.linearX ? Math.round(v).toLocaleString() : v.toFixed(1)} 
                                                stroke="#1e293b" 
                                                strokeWidth={2} 
                                                fontSize={12} 
                                                tick={{ fontWeight: 600 }}
                                                label={{ 
                                                    value: plotOpt.linearX ? xLabel.replace('log ', '') : xLabel, 
                                                    position: 'insideBottom', 
                                                    offset: 0, 
                                                    fontSize: 16, 
                                                    fontWeight: 700, 
                                                    fill: '#1e293b' 
                                                }} 
                                            />
                                            <YAxis domain={[plotOpt.ymin, plotOpt.ymax]} stroke="#1e293b" strokeWidth={2} fontSize={12} tick={{ fontWeight: 600 }} label={{ value: 'log M-dot [Msun/yr]', angle: -90, position: 'insideLeft', fontSize: 16, fontWeight: 700, fill: '#1e293b' }} />
                                            <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.2)' }} />
                                            <Legend verticalAlign="top" height={36} wrapperStyle={{ fontSize: '10px', fontWeight: 'bold' }} />
                                            
                                            {/* REFERENCE LAYERS */}
                                            {options.moreDetails && axis === 'temp' && (
                                                <React.Fragment>
                                                    {(() => {
                                                        const rsg = getShadeBounds(-20, Math.log10(4000));
                                                        return rsg && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={rsg.x1} x2={rsg.x2} fill="#dc2626" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={rsg.mid} stroke="transparent" label={{ value: "RSG", position: "top", fontSize: 11, fontWeight: "bold", fill: "#dc2626" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                    {(() => {
                                                        const ysg = getShadeBounds(Math.log10(4000), Math.log10(8000));
                                                        return ysg && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={ysg.x1} x2={ysg.x2} fill="#eab308" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={ysg.mid} stroke="transparent" label={{ value: "YSG", position: "top", fontSize: 11, fontWeight: "bold", fill: "#ca8a04" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                    {(() => {
                                                        const bsg = getShadeBounds(Math.log10(8000), Math.log10(12000));
                                                        return bsg && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={bsg.x1} x2={bsg.x2} fill="#2563eb" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={bsg.mid} stroke="transparent" label={{ value: "BSG", position: "top", fontSize: 11, fontWeight: "bold", fill: "#2563eb" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                    {(() => {
                                                        const wr = getShadeBounds(Math.log10(100000), 20);
                                                        return wr && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={wr.x1} x2={wr.x2} fill="#059669" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={wr.mid} stroke="transparent" label={{ value: "Canonical WR", position: "top", fontSize: 11, fontWeight: "bold", fill: "#059669" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                </React.Fragment>
                                            )}
                                            {options.moreDetails && axis === 'lum' && <ReferenceLine x={5.5} stroke="#64748b" strokeDasharray="5 5" label={{ value: "HD limit", position: "top", fontSize: 12, fontWeight: "bold", fill: "#64748b" }} />}
                                            {options.moreDetails && axis === 'metal' && (
                                                <React.Fragment>
                                                    {(() => {
                                                        const p3 = getShadeBounds(-40, -11);
                                                        return p3 && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={p3.x1} x2={p3.x2} fill="#94a3b8" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={p3.mid} stroke="transparent" label={{ value: "Pop III", position: "top", fontSize: 11, fontWeight: "bold", fill: "#475569" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                    {(() => {
                                                        const p2 = getShadeBounds(-11, -5);
                                                        return p2 && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={p2.x1} x2={p2.x2} fill="#64748b" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={p2.mid} stroke="transparent" label={{ value: "Pop II", position: "top", fontSize: 11, fontWeight: "bold", fill: "#334155" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                    {(() => {
                                                        const p1 = getShadeBounds(-5, 20);
                                                        return p1 && (
                                                            <React.Fragment>
                                                                <ReferenceArea x1={p1.x1} x2={p1.x2} fill="#1e293b" fillOpacity={0.1} isFront={false} />
                                                                <ReferenceLine x={p1.mid} stroke="transparent" label={{ value: "Pop I", position: "top", fontSize: 11, fontWeight: "bold", fill: "#0f172a" }} />
                                                            </React.Fragment>
                                                        );
                                                    })()}
                                                </React.Fragment>
                                            )}

                                            {Object.entries(MODEL_META).map(([key, meta]) => activeModels[key] && (
                                                <Line key={key} type="monotone" dataKey={key} stroke={meta.color} strokeDasharray={meta.dash} strokeWidth={meta.cat === 'THIN' ? 3.5 : 2.5} dot={false} animationDuration={300} connectNulls={false} />
                                            ))}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </div>
                                <div className="flex justify-center gap-4 mt-8 border-t pt-4">
                                    {[{ id: 'temp', label: 'log (Teff / K)' }, { id: 'lum', label: 'log (L / Lsun)' }, { id: 'metal', label: 'log (Z / Zsun)' }].map(opt => (
                                        <button key={opt.id} onClick={() => setAxis(opt.id)} className={`px-4 py-1.5 rounded-full text-xs font-bold transition-all ${axis === opt.id ? 'bg-blue-600 text-white shadow-md' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>{opt.label}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6 bg-white p-6 rounded-2xl border shadow-sm border-slate-200">
                                {axis !== 'lum' && (
                                    <div className="space-y-2">
                                        <div className="flex justify-between text-[11px] font-black uppercase text-slate-400"><span>log L</span><span className="text-blue-600">{params.logL}</span></div>
                                        <input type="range" min="3" max="7" step="0.1" value={params.logL} onChange={e => setParams({...params, logL: parseFloat(e.target.value)})} className="w-full" />
                                    </div>
                                )}
                                <div className="space-y-2">
                                    <div className="flex justify-between text-[11px] font-black uppercase text-slate-400"><span>Mass</span><span className="text-blue-600">{params.mass}</span></div>
                                    <input type="range" min="5" max="150" step="1" value={params.mass} onChange={e => setParams({...params, mass: parseFloat(e.target.value)})} className="w-full" />
                                </div>
                                {axis !== 'temp' && (
                                    <div className="space-y-2">
                                        <div className="flex justify-between text-[11px] font-black uppercase text-slate-400"><span>log Teff</span><span className="text-blue-600">{params.logT}</span></div>
                                        <input type="range" min="3.4" max="5.3" step="0.05" value={params.logT} onChange={e => setParams({...params, logT: parseFloat(e.target.value)})} className="w-full" />
                                    </div>
                                )}
                                {axis !== 'metal' && (
                                    <div className="space-y-2">
                                        <div className="flex justify-between text-[11px] font-black uppercase text-slate-400"><span>Z (Absolute)</span><span className="text-blue-600">{params.z}</span></div>
                                        <input type="range" min="0.0001" max="0.04" step="0.0001" value={params.z} onChange={e => setParams({...params, z: parseFloat(e.target.value)})} className="w-full" />
                                    </div>
                                )}
                                <div className="space-y-2">
                                    <div className="flex justify-between text-[11px] font-black uppercase text-slate-400"><span>Surface X</span><span className="text-blue-600">{params.X}</span></div>
                                    <input type="range" min="0" max="0.75" step="0.01" value={params.X} onChange={e => setParams({...params, X: parseFloat(e.target.value)})} className="w-full" />
                                </div>
                                {needsInitialMass && (
                                    <div className="col-span-full space-y-2 border-l-4 pl-4 border-amber-500 bg-amber-50 rounded-r-lg p-2 text-xs">
                                        <div className="flex justify-between font-black uppercase text-amber-600"><span>Initial Mass (Mi)</span><span>{params.Mi}</span></div>
                                        <input type="range" min="5" max="120" step="1" value={params.Mi} onChange={e => setParams({...params, Mi: parseFloat(e.target.value)})} className="w-full" />
                                    </div>
                                )}
                            </div>

                            <div className="border rounded-2xl overflow-hidden shadow-sm border-blue-200 bg-white">
                                <div onClick={() => setExpandedCats(p => ({ ...p, PLOT: !p.PLOT }))} className="collapsible-header flex justify-between items-center p-4 bg-blue-50 text-blue-800 border-b">
                                    <span className="text-xs font-black uppercase tracking-widest">Plot Viewport & Margins</span>
                                    <svg className={`w-4 h-4 transition-transform ${expandedCats.PLOT ? 'rotate-180' : ''}`} fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M19 9l-7 7-7-7" /></svg>
                                </div>
                                {expandedCats.PLOT && (
                                    <div className="p-6 grid grid-cols-2 md:grid-cols-7 gap-6 animate-in slide-in-from-top-1 duration-200 text-xs">
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase">X-Axis Min</label>
                                            <input type="number" step="0.1" value={plotOpt.xmin} onChange={e => setPlotOpt({...plotOpt, xmin: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase">X-Axis Max</label>
                                            <input type="number" step="0.1" value={plotOpt.xmax} onChange={e => setPlotOpt({...plotOpt, xmax: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded font-mono" />
                                        </div>
                                        <div className="flex flex-col justify-end pb-1">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" checked={plotOpt.linearX} onChange={e => setPlotOpt({...plotOpt, linearX: e.target.checked})} className="w-4 h-4" />
                                                <span className="text-[10px] font-black text-slate-400 uppercase">Linear X</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase">Y-Axis Min</label>
                                            <input type="number" step="0.5" value={plotOpt.ymin} disabled={plotOpt.autoY} onChange={e => setPlotOpt({...plotOpt, ymin: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded text-sm font-mono disabled:opacity-50" />
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase">Y-Axis Max</label>
                                            <input type="number" step="0.5" value={plotOpt.ymax} disabled={plotOpt.autoY} onChange={e => setPlotOpt({...plotOpt, ymax: parseFloat(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded text-sm font-mono disabled:opacity-50" />
                                        </div>
                                        <div className="flex flex-col justify-end pb-1">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input type="checkbox" checked={plotOpt.autoY} onChange={e => setPlotOpt({...plotOpt, autoY: e.target.checked})} className="w-4 h-4" />
                                                <span className="text-[10px] font-black text-slate-400 uppercase">Auto-fit Y</span>
                                            </label>
                                        </div>
                                        <div>
                                            <label className="text-[10px] font-black text-slate-400 uppercase">Height (px)</label>
                                            <input type="number" step="10" value={plotOpt.height} onChange={e => setPlotOpt({...plotOpt, height: parseInt(e.target.value)})} className="w-full mt-1 p-2 bg-slate-50 border rounded text-sm font-mono" />
                                        </div>
                                    </div>
                                )}
                            </div>
                        </section>
                    </main>

                    {showVinkModal && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-50 backdrop-blur-md">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full border-t-8 border-blue-600 animate-in fade-in zoom-in duration-300">
                                <h2 className="text-xl font-black text-slate-800 uppercase tracking-tight mb-2">Vink 2011 Switch</h2>
                                <p className="text-[10px] text-slate-500 mb-6 font-bold uppercase">Transition parameters for sticky optically-thick winds.</p>
                                <div className="space-y-4">
                                    {['mdot', 'L', 'M'].map(key => (
                                        <div key={key}>
                                            <label className="text-[10px] font-black uppercase text-slate-400">{key === 'mdot' ? 'log M-dot switch' : key + ' switch'}</label>
                                            <input type="number" step={key === 'mdot' ? 0.1 : 1} value={key === 'mdot' ? log10(vinkSettings.mdot) : vinkSettings[key]} onChange={e => setVinkSettings({...vinkSettings, [key]: key === 'mdot' ? Math.pow(10, parseFloat(e.target.value)) : parseFloat(e.target.value)})} className="w-full p-2 bg-slate-50 rounded-lg border font-mono text-sm" />
                                        </div>
                                    ))}
                                    <button onClick={() => setShowVinkModal(false)} className="w-full py-3 bg-blue-600 text-white rounded-xl font-black uppercase hover:bg-blue-700 transition-all mt-4">Accept</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
